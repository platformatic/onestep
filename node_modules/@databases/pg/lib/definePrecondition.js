"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function definePrecondition(fn) {
    let done = false;
    let doing = false;
    let queue = [];
    const consumeQueue = () => {
        const q = queue;
        queue = [];
        return q;
    };
    const emptyPromise = Promise.resolve(undefined);
    const callPrecondition = async (...args) => {
        if (!done) {
            if (doing) {
                return new Promise((resolve, reject) => queue.push({ resolve, reject }));
            }
            else {
                doing = true;
                return fn(...args).then((value) => {
                    done = true;
                    doing = false;
                    for (const { resolve } of consumeQueue()) {
                        resolve(undefined);
                    }
                    return value;
                }, (err) => {
                    doing = false;
                    for (const { reject } of consumeQueue()) {
                        reject(err);
                    }
                    throw err;
                });
            }
        }
        else {
            return emptyPromise;
        }
    };
    return {
        hasDonePrecondition: () => {
            return done;
        },
        callPrecondition,
        resetPrecondition: () => {
            done = false;
        },
    };
}
exports.default = definePrecondition;
//# sourceMappingURL=definePrecondition.js.map